<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flowers Curve</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
    <script src="Blob.js"></script>
    <script src="FileSaver.min.js"></script>
    <script src="gif.js"></script>
    <script src="canvas-toBlob.js"></script>
    <style>
        .checkbox {
            width: 15px;
            height: 15px;
        }

        .tadjusted tr td {
            height: 20px;
        }

        #settings tr td {
            cursor: auto;
        }

        #settings tr td:hover {
            cursor: pointer;
        }

        #button-group tr td {
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .top-cat {
            margin-top: 5px;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .no-animation {
            -webkit-transition: none;
            -moz-transition: none;
            -ms-transition: none;
            -o-transition: none;
            transition: none;
        }
    </style>
</head>
<body style="margin: auto auto; width: 1180px">
<table>
    <thead>
    <tr>
        <td style="text-align: center; margin-bottom: 0;padding-bottom: 0">
            <p class="top-cat">
            <h3>Dots Setting</h3></p>
        </td>
        <td style="text-align: center; margin-bottom: 0;padding-bottom: 0">
            <p class="top-cat">
            <h3>Canvas</h3></p>
        </td>
        <td style="text-align: center; margin-bottom: 0;padding-bottom: 0">
            <p class="top-cat">
            <h3>Parameters</h3></p>
        </td>
    </tr>
    </thead>
    <tr>
        <td style="width: 250px;vertical-align: top;text-align: center">
            <table class="table table-striped table-sm" style="text-align: left;">
                <tr style="text-align: center">
                    <td colspan="2"><h5>Dots</h5></td>
                </tr>
                <tr>
                    <td><label for="dotSize">Size</label></td>
                    <td>
                        <input type="number" id="dotSize" style="width: 50px" value="2" step="1" max="200" min="1">
                    </td>
                </tr>
                <tr>
                    <td><label for="dotColor">Color</label></td>
                    <td><input type="color" id="dotColor"/></td>
                </tr>
                <tr>
                    <td><label for="dotDistance">Distance to center</label></td>
                    <td><input type="number" id="dotDistance" style="width: 50px" value="80" step="1" max="800" min="1">
                    </td>
                </tr>
                <tr>
                    <td><label for="dotRotOffset">Rotation</label></td>
                    <td><input type="number" id="dotRotOffset" style="width: 50px" value="0" step="1" max="360" min="0">째
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: center">
                        <button type="button" class="btn btn-primary" onclick="addDot()">Add</button>&nbsp;&nbsp;&nbsp;
                        <button type="button" class="btn btn-secondary" onclick="randomDot()">Random</button>&nbsp;&nbsp;&nbsp;
                        <button type="button" class="btn" data-toggle="modal" data-target="#RangeModalCenter">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                        </button>
                        <div class="modal fade" id="RangeModalCenter" tabindex="-1" role="dialog"
                             aria-labelledby="RangeModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="RangeModalLongTitle">Adjust Random Range</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table">
                                            <thead class="thead-dark">
                                            <tr>
                                                <th>Items</th>
                                                <th>Min</th>
                                                <th>Max</th>
                                            </tr>
                                            </thead>
                                            <tr>
                                                <td>Dot Size</td>
                                                <td><input id="dotSizeMin" style="width: 50px;" type="number" min="1"
                                                           max="10" value="1"></td>
                                                <td><input id="dotSizeMax" style="width: 50px;" type="number" min="1"
                                                           max="10" value="5"></td>
                                            </tr>
                                            <tr>
                                                <td>Dot Distance</td>
                                                <td><input id="dotDistanceMin" style="width: 50px;" type="number"
                                                           min="0" max="400" value="1"></td>
                                                <td><input id="dotDistanceMax" style="width: 50px;" type="number"
                                                           min="0" max="400" value="120"></td>
                                            </tr>
                                            <tr>
                                                <td>Dot Rotation</td>
                                                <td><input id="dotRotMin" style="width: 50px;" type="number" min="0"
                                                           max="359" value="0"></td>
                                                <td><input id="dotRotMax" style="width: 50px;" type="number" min="0"
                                                           max="359" value="359"></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
            <table class="table table-striped table-sm table-hover" style="text-align: left;" id="settings">
                <tr>
                    <th colspan="2" style="text-align: center"><h5>Dot List</h5></th>
                </tr>
            </table>
            <div class="modal fade" id="DotModalCenter" tabindex="-1" role="dialog"
                 aria-labelledby="DotModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="DotModalLongTitle">Modify dot parameters</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-striped table-bordered"
                                   style="text-align: left; width: 360px; margin: auto auto; font-size: 21px;">
                                <tr>
                                    <th><label for="m-dotSize">Size</label></th>
                                    <td>
                                        <input type="hidden" id="m-dotID" value="">
                                        <input type="number" id="m-dotSize" style="width: 60px" value="6" step="1"
                                               max="200" min="1">
                                    </td>
                                </tr>
                                <tr>
                                    <th><label for="m-dotColor">Color</label></th>
                                    <td><input type="color" id="m-dotColor"/></td>
                                </tr>
                                <tr>
                                    <th><label for="m-dotDistance">Distance to center</label></th>
                                    <td><input type="number" id="m-dotDistance" style="width: 60px" value="80" step="1"
                                               max="800" min="1">
                                    </td>
                                </tr>
                                <tr>
                                    <th><label for="m-dotRot">Rotation</label></th>
                                    <td><input type="number" id="m-dotRot" style="width: 60px" value="0" step="1"
                                               max="360" min="0">째
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="postModify()">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </td>
        <td style="text-align: center">
            <div style="position: relative; width: 640px; height: 640px">
                <canvas id="canvas-top" width="640px" height="640px"
                        style="left:0;position: absolute;z-index: 1"></canvas>
                <canvas id="canvas-bottom" width="640px" height="640px"
                        style="left: 0;position: absolute;z-index: 0"></canvas>
                <canvas id="canvas-temp" width="640px" height="640px"
                        style="left: 0;position: absolute;z-index: -1; display: none"></canvas>
            </div>
            <div id="progressdiv" class="progress"
                 style="width: 600px; height: 25px; margin: auto auto; text-align: center; position: relative">
                <div id="progressbar" class="progress-bar progress-bar-striped progress-bar-animated no-animation"
                     role="progressbar" style="width: 0%;"
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                <div style="position: absolute; left: 0; width: 600px; text-align: center; height:25px; line-height:25px;">
                    <div id="progressLabel" style="display: inline-block; font-size: 18px;"></div>
                </div>
            </div>
        </td>
        <td style="width: 250px;vertical-align: top;text-align: center">
            <table class="table table-striped table-sm" style="text-align: left;">
                <tr>
                    <td><label for="mcRadius">Outer circle radius</label></td>
                    <td>
                        <input type="number" id="mcRadius" style="width: 50px" value="300" step="1" max="1000"
                               min="100">
                    </td>
                </tr>
                <tr>
                    <td><label for="innerRadius">Inner circle radius</label></td>
                    <td>
                        <input type="number" id="innerRadius" style="width: 50px" value="120" step="1" max="800"
                               min="10" onclick="adjustDotDistanceCap(this)">
                    </td>
                </tr>
                <tr>
                    <td><label for="showOC">Show outer circle</label></td>
                    <td><input type="checkbox" id="showOC" class="checkbox" checked/></td>
                </tr>
                <tr>
                    <td><label for="showIC">Show inner circle</label></td>
                    <td><input type="checkbox" id="showIC" class="checkbox"/></td>
                </tr>
                <tr>
                    <td><label for="showSk" title="lines connecting the center of the inner circle and the dots">Show
                        skeleton</label></td>
                    <td><input type="checkbox" id="showSk" class="checkbox"/></td>
                </tr>
                <tr>
                    <td><label for="clearBeforeDrawing">Clear before drawing</label></td>
                    <td><input type="checkbox" id="clearBeforeDrawing" class="checkbox"/></td>
                </tr>
                <tr>
                    <td>
                        <label for="step"
                               title="A number in radians defining the interval for drawing the inner circle and the dots">
                            Drawing step</label>
                    </td>
                    <td>
                        <input type="number" id="step" style="width: 60px"
                               value="0.005" step="0.001" max="0.5" min="0.001">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="delay" title="Delay between each drawing step, in milliseconds">
                            Drawing delay
                        </label>
                    </td>
                    <td>
                        <input type="number" id="delay" style="width: 50px" value="2" step="1" max="10" min="0">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="ratio" title="A decimal out of one defining the completeness">
                            Completeness
                        </label>
                    </td>
                    <td>
                        <input type="number" id="ratio" style="width: 60px" value="1" step="0.001" max="1" min="0.001">
                    </td>
                </tr>
                <tr>
                    <td><label for="direction">Reverse direction</label></td>
                    <td><input type="checkbox" id="direction" class="checkbox"></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <label for="configloader">Load Config</label>
                        <input type="file" id="configloader" onchange="loadConfig(this.files)" style="width:220px;"/>
                    </td>
                </tr>
            </table>
            <table id="button-group" style="width: 200px; margin: auto auto; text-align: center;">
                <tr>
                    <td>
                        <button class="btn btn-warning" onclick="caller(undefined)" style="width:75px;">Draw</button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-info" onclick="previewRuler()">Preview</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger" onclick="stopDrawing()" style="width:50px;">
                                Stop
                            </button>
                            <button type="button" class="btn btn-danger dropdown-toggle dropdown-toggle-split"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="javascript:clear()">Clear</a>
                                <a class="dropdown-item" onclick="clearBottom()">Clear circles</a>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info" onclick="saveConfig()" style="width:50px;">Save
                            </button>
                            <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" data-toggle="modal" data-target="#PNGModalCenter">Save as
                                    PNG</a>
                                <a class="dropdown-item" data-toggle="modal" data-target="#GIFModalCenter">Save as
                                    GIF</a>
                            </div>
                        </div>
                        <div class="modal fade" id="GIFModalCenter" tabindex="-1" role="dialog"
                             aria-labelledby="GIFModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="GIFModalLongTitle">GIF parameters</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-striped table-bordered table-sm"
                                               style="text-align: left; width: 360px; margin: auto auto; font-size: 21px;">
                                            <tr>
                                                <th><label for="f-size">Frame size</label></th>
                                                <td>
                                                    <input type="number" id="f-size" style="width: 80px" value="320"
                                                           step="1" max="640" min="1">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="f-interval"
                                                           title="Indicates how frequently should frames be taken. 40 means 1 frame per 40 drawing steps">
                                                        Frame interval
                                                    </label>
                                                </th>
                                                <td>
                                                    <input type="number" id="f-interval" style="width: 60px" value="40"
                                                           step="1" max="200" min="1">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="f-delay"
                                                           title="A number in milliseconds that indicates how long a single frame should stay">
                                                        Frame delay
                                                    </label>
                                                </th>
                                                <td><input type="number" id="f-delay" style="width: 60px" value="20"
                                                           step="1" max="1000" min="1">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th><label for="f-transparent">Transparent</label></th>
                                                <td><input type="checkbox" id="f-transparent"
                                                           style="width: 20px; height: 20px"
                                                           onchange="$('#f-bgcolor').attr('disabled', this.checked)">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th><label for="f-bgcolor">Background color</label></th>
                                                <td><input type="color" id="f-bgcolor" value="#FFFFFF"/></td>
                                            </tr>
                                            <tr>
                                                <th><label for="f-quality"
                                                           title="The lower the number, the better the GIF quality will be">Quality</label>
                                                </th>
                                                <td><input type="number" id="f-quality" style="width: 60px" value="10"
                                                           step="1" max="20" min="1">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <label for="f-lastdelay"
                                                           title="A number in milliseconds that defines how long should the last frame stay">
                                                        Last frame delay
                                                    </label>
                                                </th>
                                                <td>
                                                    <input type="number" id="f-lastdelay" style="width: 80px"
                                                           value="1000" step="1"
                                                           max="5000" min="1">
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                            Close
                                        </button>
                                        <button type="button" class="btn btn-primary" data-dismiss="modal"
                                                onclick="saveToGIF()">
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="PNGModalCenter" tabindex="-1" role="dialog"
                             aria-labelledby="GIFModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="PNGModalLongTitle">PNG parameters</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table table-striped table-bordered"
                                               style="text-align: left; width: 360px; margin: auto auto; font-size: 21px;">
                                            <tr>
                                                <th><label for="p-size">PNG size</label></th>
                                                <td>
                                                    <input type="number" id="p-size" style="width: 80px" value="320"
                                                           step="1" max="640" min="1">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th><label for="p-transparent">Transparent</label></th>
                                                <td><input type="checkbox" id="p-transparent"
                                                           style="width: 20px; height: 20px"
                                                           onchange="$('#p-bgcolor').attr('disabled', this.checked)">
                                                </td>
                                            </tr>
                                            <tr>
                                                <th><label for="p-bgcolor">Background color</label></th>
                                                <td><input type="color" id="p-bgcolor" value="#FFFFFF"/></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                            Close
                                        </button>
                                        <button type="button" class="btn btn-primary" data-dismiss="modal"
                                                onclick="saveToPNG()">
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });
    var TwoPI = Math.PI * 2;

    var topCanvas = document.getElementById('canvas-top');
    var bottomCanvas = document.getElementById('canvas-bottom');
    var outerCircleParam = document.getElementById('mcRadius');
    var innerCircleParam = document.getElementById('innerRadius');
    var outerCircleCheck = document.getElementById('showOC');
    var innerCircleCheck = document.getElementById('showIC');
    var clearBeforeDrawingCheck = document.getElementById('clearBeforeDrawing');
    var drawingStepParam = document.getElementById('step');
    var drawingDelayParam = document.getElementById('delay');
    var completenessParam = document.getElementById('ratio');
    var skeletonCheck = document.getElementById('showSk');
    var reverseDirectionCheck = document.getElementById('direction');

    var dotSizeMinParam = document.getElementById('dotSizeMin');
    var dotSizeMaxParam = document.getElementById('dotSizeMax');
    var dotDistanceMinParam = document.getElementById('dotDistanceMin');
    var dotDistanceMaxParam = document.getElementById('dotDistanceMax');
    var dotRotMinParam = document.getElementById('dotRotMin');
    var dotRotMaxParam = document.getElementById('dotRotMax');

    var mDotSize = document.getElementById('m-dotSize');
    var mDotColor = document.getElementById('m-dotColor');
    var mDotDistance = document.getElementById('m-dotDistance');
    var mDotRot = document.getElementById('m-dotRot');
    var mDotID = document.getElementById('m-dotID');

    var gifSizeParam = document.getElementById('f-size');
    var gifIntervalParam = document.getElementById('f-interval');
    var gifTransparentCheck = document.getElementById('f-transparent');
    var gifBgColorParam = document.getElementById('f-bgcolor');
    var gifFrameDelayParam = document.getElementById('f-delay');
    var gifQualityParam = document.getElementById('f-quality');
    var gifLastFrameDelayParam = document.getElementById('f-lastdelay');

    var pngSizeParam = document.getElementById('p-size');
    var pngTransparentCheck = document.getElementById('p-transparent');
    var pngBgColorParam = document.getElementById('p-bgcolor');

    var dots = {};
    var flag = {stop: false};
    var currentJobs = [];

    window.onload = function (ev) {
        parseConfigJSON(localStorage.getItem('cache'));
    };

    window.onchange = function (ev) {
        saveConfigToBrowser();
    };

    function removeDot(id) {
        delete dots[id];
        $('#' + id).hide(300, function () {
            $('#' + id).remove();
        });
        saveConfigToBrowser();
    }

    function addDot() {
        var dotSize = +$('#dotSize').val();
        var dotColor = $('#dotColor').val();
        var dotDist = +$('#dotDistance').val();
        var dotRot = +$('#dotRotOffset').val();

        var dotDistCap = +innerCircleParam.value;
        if (dotDist > dotDistCap)
            alert('Dot distance should be no greater than the inner circle radius');
        else
            addDotHelper((new Date()).valueOf().toString(), dotSize, dotColor, dotDist, dotRot);
    }

    /**
     * return a random integer in [min, max]
     * @param {number} min
     * @param {number} max
     * @return number
     * */
    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min)
    }

    function randomDot() {
        var dotDistCap = +innerCircleParam.value;
        var randDotDistMax = +dotDistanceMaxParam.value;

        var dotSize = randInt(+dotSizeMinParam.value, +dotSizeMaxParam.value);
        var dotColor = '#' + (Math.floor(Math.random() * 256 * 256 * 256)).toString(16);
        var dotDist = randInt(+dotDistanceMinParam.value, randDotDistMax > dotDistCap ? dotDistCap : randDotDistMax);
        var dotRot = randInt(+dotRotMinParam.value, +dotRotMaxParam.value);
        addDotHelper((new Date()).valueOf().toString(), dotSize, dotColor, dotDist, dotRot);
    }

    function addDotHelper(currentTime, dotSize, dotColor, dotDist, dotRot) {
        dots[currentTime] = new Dot(dotSize, dotColor, dotDist, dotRot);
        $('#settings').append("<tr id=\"" + currentTime + "\">" +
            "                    <td onclick='preModify(this)' data-toggle=\"modal\" data-target=\"#DotModalCenter\">Distance: " + dotDist + "&nbsp;&nbsp;Color:" +
            "                        <span style=\"width: 15px; height: 15px; background-color: " + dotColor + ";display: inline-block\"></span><br/>" +
            "                        Size: " + dotSize + "&nbsp;&nbsp;Rotation: " + dotRot + "째" +
            "                    </td>" +
            "                    <th width='50px'>" +
            "                        <button type=\"button\" class=\"close\" aria-label=\"Close\" onclick=\"removeDot('" + currentTime + "')\">" +
            "                            <span aria-hidden=\"true\">&times;</span>" +
            "                        </button>" +
            "                    </th>" +
            "                </tr>"
        );
        saveConfigToBrowser();
    }

    function preModify(td) {
        var dot = dots[td.parentNode.id];
        mDotSize.value = dot.size;
        mDotColor.value = dot.color;
        mDotDistance.value = dot.distance;
        mDotRot.value = Math.round(dot.rotOffset / Math.PI * 180);
        mDotID.value = td.parentNode.id;
    }

    function postModify() {
        var dot = dots[mDotID.value];
        var dotSize = +mDotSize.value;
        var dotColor = mDotColor.value;
        var dotDist = +mDotDistance.value;
        var dotRot = +mDotRot.value;
        var tr = document.getElementById(mDotID.value);
        tr.cells[0].innerHTML = "Distance: " + dotDist + "&nbsp;&nbsp;Color:" +
            "                        <span style=\"width: 15px; height: 15px; background-color: " + dotColor + ";display: inline-block\"></span><br/>" +
            "                        Size: " + dotSize + "&nbsp;&nbsp;Rotation: " + dotRot + "째";
        dot.size = dotSize;
        dot.color = dotColor;
        dot.distance = dotDist;
        dot.rotOffset = dotRot / 180 * Math.PI;
        saveConfigToBrowser();
    }

    function stopDrawing() {
        flag.stop = true;
        for (var i = 0; i < currentJobs.length; i++) {
            clearTimeout(currentJobs[i]);
        }
        currentJobs = [];
    }

    function adjustDotDistanceCap(input) {
        var newCap = +input.value;
        // var oldCap = +dotDistanceMaxParam.max;
        dotDistanceMaxParam.max = newCap;
        var oldValue = +dotDistanceMaxParam.value;
        if (oldValue > newCap)
            dotDistanceMaxParam.value = newCap;
    }

    function saveConfigToBrowser() {
        localStorage.setItem('cache', getConfigJSON());
    }

    function getConfigJSON() {
        var config = {
            outerCircleRadius: +outerCircleParam.value,
            innerCircleRadius: +innerCircleParam.value,
            showOuterCircle: outerCircleCheck.checked,
            showInnerCircle: innerCircleCheck.checked,
            showSkeleton: skeletonCheck.checked,
            clearBeforeDrawing: clearBeforeDrawingCheck.checked,
            drawingStep: +drawingStepParam.value,
            drawingDelay: +drawingDelayParam.value,
            completeness: +completenessParam.value,
            reverseDirection: reverseDirectionCheck.checked,

            dots: dots,

            dotSizeMin: +dotSizeMinParam.value,
            dotSizeMax: +dotSizeMaxParam.value,
            dotDistanceMin: +dotDistanceMinParam.value,
            dotDistanceMax: +dotDistanceMaxParam.value,
            dotRotMin: +dotRotMinParam.value,
            dotRotMax: +dotRotMaxParam.value,

            frameSize: +gifSizeParam.value,
            frameDelay: +gifFrameDelayParam.value,
            frameTransparent: gifTransparentCheck.checked,
            frameBgColor: gifBgColorParam.value,
            frameQuality: +gifQualityParam.value,
            frameInterval: +gifIntervalParam.value,
            lastFrameDelay: +gifLastFrameDelayParam.value,

            pngSize: +pngSizeParam.value,
            pngTransparent: pngTransparentCheck.checked,
            pngBgColor: pngBgColorParam.value
        };
        return JSON.stringify(config);
    }

    function parseConfigJSON(json) {
        if (json === "" || json === null) return;
        try {
            var obj = JSON.parse(json);
            outerCircleParam.value = obj.outerCircleRadius === undefined ? 300 : obj.outerCircleRadius;
            innerCircleParam.value = obj.innerCircleRadius === undefined ? 120 : obj.innerCircleRadius;
            outerCircleCheck.checked = obj.showOuterCircle === undefined ? true : obj.showOuterCircle;
            innerCircleCheck.checked = obj.showInnerCircle === undefined ? false : obj.showInnerCircle;
            skeletonCheck.checked = obj.showSkeleton === undefined ? false : obj.showSkeleton;
            clearBeforeDrawingCheck.checked = obj.clearBeforeDrawing === undefined ? true : obj.clearBeforeDrawing;
            drawingStepParam.value = obj.drawingStep === undefined ? 0.005 : obj.drawingStep;
            drawingDelayParam.value = obj.drawingDelay === undefined ? 2 : obj.drawingDelay;
            completenessParam.value = obj.completeness === undefined ? 1 : obj.completeness;
            reverseDirectionCheck.checked = obj.reverseDirection === undefined ? false : obj.reverseDirection;

            dots = obj.dots;

            dotSizeMinParam.value = obj.dotSizeMin === undefined ? 1 : obj.dotSizeMin;
            dotSizeMaxParam.value = obj.dotSizeMax === undefined ? 5 : obj.dotSizeMax;
            dotDistanceMinParam.value = obj.dotDistanceMin === undefined ? 0 : obj.dotDistanceMin;
            dotDistanceMaxParam.value = obj.dotDistanceMax === undefined ? 120 : obj.dotDistanceMax;
            dotRotMinParam.value = obj.dotRotMin === undefined ? 0 : obj.dotRotMin;
            dotRotMaxParam.value = obj.dotRotMax === undefined ? 360 : obj.dotRotMax;

            gifSizeParam.value = obj.frameSize === undefined ? 320 : obj.frameSize;
            gifFrameDelayParam.value = obj.frameDelay === undefined ? 25 : obj.frameDelay;
            gifTransparentCheck.checked = obj.frameTransparent === undefined ? false : obj.frameTransparent;
            gifBgColorParam.value = obj.frameBgColor === undefined ? '#FFFFFF' : obj.frameBgColor;

            if (gifTransparentCheck.checked)
                gifBgColorParam.disabled = true;

            gifQualityParam.value = obj.frameQuality === undefined ? 10 : obj.frameQuality;
            gifIntervalParam.value = obj.frameInterval === undefined ? 40 : obj.frameInterval;
            gifLastFrameDelayParam.value = obj.lastFrameDelay === undefined ? 1000 : obj.lastFrameDelay;

            pngSizeParam.value = obj.pngSize === undefined ? 640 : obj.pngSize;
            pngTransparentCheck.checked = obj.pngTransparent === undefined ? false : obj.pngTransparent;
            pngBgColorParam.value = obj.pngBgColor === undefined ? '#FFFFFF' : obj.pngBgColor;

            if (pngTransparentCheck.checked)
                pngBgColorParam.disabled = true;

            for (var key in dots) {
                addDotHelper(key, dots[key].size, dots[key].color, dots[key].distance, Math.round(180 * dots[key].rotOffset / Math.PI));
            }
        } catch (e) {
            alert(e);
        }
    }

    function saveConfig() {
        saveAs(new Blob([getConfigJSON()], {type: "text/plain;charset=utf-8"}), "config.json");
    }

    function loadConfig(files) {
        if (files.length) {
            var file = files[0];
            var reader = new FileReader();
            reader.onload = function () {
                parseConfigJSON(this.result);
            };
            reader.readAsText(file);
        }
    }

    function saveToPNG() {
        var innerCircleRadius = +innerCircleParam.value;
        var outerCircle = new Circle(topCanvas.width / 2, topCanvas.height / 2, +outerCircleParam.value);

        var ruler = new Ruler(new Circle(outerCircle.x, outerCircle.y + outerCircle.radius - innerCircleRadius, innerCircleRadius), getDotArray());
        ruler.showCircle = innerCircleCheck.checked;
        ruler.showSkeleton = skeletonCheck.checked;
        ruler.reverse = reverseDirectionCheck.checked;

        stopDrawing();
        flag.stop = false;

        draw(outerCircle, ruler, 0, +drawingStepParam.value, +completenessParam.value, function () {
            var pngSize = +pngSizeParam.value;
            var transparent = pngTransparentCheck.checked;
            var bgColor = pngBgColorParam.value;

            var tempCanvas = document.getElementById('canvas-temp');
            tempCanvas.width = pngSize;
            tempCanvas.height = pngSize;
            var tempCxt = tempCanvas.getContext('2d');

            if (!transparent) {
                tempCxt.fillStyle = bgColor;
                tempCxt.fillRect(0, 0, tempCanvas.width, tempCanvas.height)
            }
            tempCxt.scale(pngSize / topCanvas.width, pngSize / topCanvas.width);
            tempCxt.drawImage(bottomCanvas, 0, 0);
            tempCxt.drawImage(topCanvas, 0, 0);
            tempCanvas.toBlobHD(function (blob) {
                saveAs(blob, 'flowers-curve.png');
            });
        });
    }

    function saveToGIF() {
        var frameSize = +gifSizeParam.value;
        var transparent = gifTransparentCheck.checked;
        var gif = new GIF({
            workers: 4,
            quality: +gifQualityParam.value,
            workerScript: './gif.worker.js',
            width: frameSize,
            height: frameSize
        });

        var outerCircleRadius = +outerCircleParam.value;
        var innerCircleRadius = +innerCircleParam.value;
        stopDrawing();
        flag.stop = false;

        var topCxt = topCanvas.getContext('2d');
        var bottomCxt = bottomCanvas.getContext('2d');

        var tempCanvas = document.getElementById('canvas-temp');
        tempCanvas.width = frameSize;
        tempCanvas.height = frameSize;
        var tempCxt = tempCanvas.getContext('2d');

        if (!transparent) {
            tempCxt.fillStyle = gifBgColorParam.value;
            tempCxt.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        }

        tempCxt.scale(frameSize / topCanvas.width, frameSize / topCanvas.height);

        if (clearBeforeDrawingCheck.checked)
            clear();

        var outerCircle = new Circle(topCanvas.width / 2, topCanvas.height / 2, outerCircleRadius);
        if (outerCircleCheck.checked)
            outerCircle.draw(bottomCxt);

        var ruler = new Ruler(new Circle(outerCircle.x, outerCircle.y + outerCircle.radius - innerCircleRadius, innerCircleRadius), getDotArray());
        ruler.showCircle = innerCircleCheck.checked;
        ruler.showSkeleton = skeletonCheck.checked;
        ruler.reverse = reverseDirectionCheck.checked;

        var radiiDiff = outerCircle.radius - ruler.circle.radius;
        var drawingInterval = +drawingDelayParam.value;
        var innerCirclePerimeter = ruler.circle.radius * 2 * Math.PI;
        var outerCirclePerimeter = outerCircleRadius * 2 * Math.PI;
        var drawingStep = +drawingStepParam.value;
        var completeness = +completenessParam.value;
        var totalRotationAngle = completeness * TwoPI * lcm(outerCircleRadius, ruler.circle.radius) / outerCircleRadius;
        var initialRotation = Math.PI * 1.5;

        var progressLabel = $('#progressLabel');
        var progressbar = $('#progressbar');
        progressbar.width('0%');

        var frameInterval = +gifIntervalParam.value;
        var frameDelay = +gifFrameDelayParam.value;
        for (var i = initialRotation, delay = 0, counter = 0; i < initialRotation + totalRotationAngle; i += drawingStep, delay += drawingInterval, counter += 1) {
            currentJobs.push((function (i, delay, counter) {
                    return setTimeout(function () {
                        if (!flag.stop) {
                            ruler.erase(bottomCxt);
                            if (outerCircleCheck.checked)
                                outerCircle.draw(bottomCxt);

                            var newPos = rad2cor(outerCircle.x, outerCircle.y, radiiDiff, i);
                            ruler.moveTo(newPos[0], newPos[1]);
                            ruler.angle = (i - initialRotation) * outerCirclePerimeter / innerCirclePerimeter;
                            ruler.draw(topCxt, bottomCxt);

                            if (counter % frameInterval === 0) {
                                if (transparent)
                                    tempCxt.clearRect(0, 0, topCanvas.width, topCanvas.height);
                                else
                                    tempCxt.fillRect(0, 0, topCanvas.width, topCanvas.height);
                                tempCxt.drawImage(bottomCanvas, 0, 0);
                                tempCxt.drawImage(topCanvas, 0, 0);
                                gif.addFrame(tempCxt, {
                                    copy: true,
                                    delay: frameDelay //frameInterval + frameInterval * drawingStep
                                });

                                var progress = (i - initialRotation) / totalRotationAngle * 100;
                                progressbar.width(progress + '%');
                                progressLabel.text('Drawing: ' + progress.toFixed(1) + '%');
                            }
                        }
                    }, delay);
                }
            )(i, delay, counter));
        }
        currentJobs.push((function (i, delay) {
                return setTimeout(function () {
                    if (!flag.stop) {
                        if (transparent)
                            tempCxt.clearRect(0, 0, topCanvas.width, topCanvas.height);
                        else
                            tempCxt.fillRect(0, 0, topCanvas.width, topCanvas.height);

                        tempCxt.drawImage(bottomCanvas, 0, 0);
                        tempCxt.drawImage(topCanvas, 0, 0);
                        gif.addFrame(tempCxt, {
                            copy: true,
                            delay: +gifLastFrameDelayParam.value
                        });

                        progressbar.width('0%');

                        gif.on('progress', function (p) {
                            if (Math.abs(1 - p) < 0.0001) {
                                progressbar.width('100%');
                                progressLabel.text('Save as GIF: Finished');
                            }
                            else {
                                p = p * 100;
                                progressbar.width(p + '%');
                                progressLabel.text('Save as GIF: ' + p.toFixed(1) + '%');
                            }
                        });

                        gif.on('finished', function (blob) {
                            saveAs(blob, 'flowers-curve.gif');
                        });

                        gif.render();
                    }
                }, delay);
            }
        )(i, delay + drawingInterval));
    }

    function getDotArray() {
        var dotArray = [];
        for (var key in dots) {
            dotArray.push(dots[key]);
        }
        return dotArray;
    }

    function previewRuler() {
        var topCxt = topCanvas.getContext('2d');
        var bottomCxt = bottomCanvas.getContext('2d');

        clear();

        var outerCircle = new Circle(topCanvas.width / 2, topCanvas.height / 2, +outerCircleParam.value);
        outerCircle.draw(bottomCxt);

        var ruler = new Ruler(new Circle(outerCircle.x, outerCircle.y + outerCircle.radius - +innerCircleParam.value, +innerCircleParam.value), getDotArray());
        ruler.showCircle = true;
        ruler.showSkeleton = true;
        ruler.reverse = reverseDirectionCheck.checked;
        ruler.draw(topCxt, bottomCxt);
    }

    function clear() {
        clearTop();
        clearBottom();
    }

    function clearTop() {
        var topCxt = topCanvas.getContext('2d');
        topCxt.clearRect(0, 0, topCanvas.width, topCanvas.height);
    }

    function clearBottom() {
        var bottomCxt = bottomCanvas.getContext('2d');
        bottomCxt.clearRect(0, 0, bottomCanvas.width, bottomCanvas.height);
    }

    /**
     * @param {Function} callback
     * */
    function caller(callback) {
        var innerCircleRadius = +innerCircleParam.value;
        var outerCircle = new Circle(topCanvas.width / 2, topCanvas.height / 2, +outerCircleParam.value);

        var ruler = new Ruler(new Circle(outerCircle.x, outerCircle.y + outerCircle.radius - innerCircleRadius, innerCircleRadius), getDotArray());
        ruler.showCircle = innerCircleCheck.checked;
        ruler.showSkeleton = skeletonCheck.checked;
        ruler.reverse = reverseDirectionCheck.checked;

        stopDrawing();
        flag.stop = false;

        draw(outerCircle, ruler, +drawingDelayParam.value, +drawingStepParam.value, +completenessParam.value, callback);
    }

    /**
     * @param {Circle} outerCircle
     * @param {Ruler} ruler
     * @param {number} drawingInterval
     * @param {number} drawingStep
     * @param {number} completeness
     * @param {Function} callback
     * */
    function draw(outerCircle, ruler, drawingInterval, drawingStep, completeness, callback) {
        var topCxt = topCanvas.getContext('2d');
        var bottomCxt = bottomCanvas.getContext('2d');

        if (clearBeforeDrawingCheck.checked)
            clear();

        if (outerCircleCheck.checked)
            outerCircle.draw(bottomCxt);

        var progressLabel = $('#progressLabel');
        var progressbar = $('#progressbar');
        progressbar.width('0%');

        var radiiDiff = outerCircle.radius - ruler.circle.radius;
        var totalRotationAngle = completeness * TwoPI * lcm(outerCircle.radius, ruler.circle.radius) / outerCircle.radius;
        var initialRotation = Math.PI * 1.5;
        for (var i = initialRotation, delay = 0, counter = 0; i < initialRotation + totalRotationAngle; i += drawingStep, delay += drawingInterval, counter += 1) {
            currentJobs.push((function (i, delay, counter) {
                    return setTimeout(function () {
                        if (!flag.stop) {
                            ruler.erase(bottomCxt);
                            if (outerCircleCheck.checked)
                                outerCircle.draw(bottomCxt);

                            var newPos = rad2cor(outerCircle.x, outerCircle.y, radiiDiff, i);
                            ruler.moveTo(newPos[0], newPos[1]);
                            ruler.angle = (i - initialRotation) * outerCircle.radius / ruler.circle.radius;
                            ruler.draw(topCxt, bottomCxt);

                            if (counter % 20 === 0) {
                                var progress = (i - initialRotation) / totalRotationAngle * 100;
                                progressbar.width(progress + '%');
                                progressLabel.text('Drawing: ' + progress.toFixed(1) + '%');
                            }
                        }
                    }, delay);
                }
            )(i, delay, counter));
        }
        currentJobs.push((function (delay) {
                return setTimeout(function () {
                    progressbar.width('100%');
                    progressLabel.text('Drawing: Finished');
                    if (callback !== undefined)
                        callback()
                }, delay);
            }
        )(delay));
    }

    /**
     * @param {number} x
     * @param {number} y
     * @return number
     * */
    function lcm(x, y) {
        var a = x, b = y;
        while (a % b !== 0) {
            var c = a % b;
            a = b;
            b = c;
        }
        return x * y / b
    }

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} radius
     * @param {number} rad
     * @return Array
     * */
    function rad2cor(x, y, radius, rad) {
        return [x + radius * Math.cos(rad), y - radius * Math.sin(rad)];
    }

    /**
     * @constructor
     * @param {Circle} circle
     * @param {Array} dots
     * */
    function Ruler(circle, dots) {
        this.circle = circle;
        this.dots = dots;
        this.angle = 0;
        this.showCircle = true;
        this.showSkeleton = true;
        this.reverse = false;

        /**
         * @param {CanvasRenderingContext2D} topCxt
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.draw = function (topCxt, bottomCxt) {
            this.drawCircle(bottomCxt);
            this.drawDots(topCxt);
            this.drawSkeleton(bottomCxt);
        };
        /**
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.erase = function (bottomCxt) {
            if (this.showCircle || this.showSkeleton) {
                var previousLineWidth = bottomCxt.lineWidth;
                bottomCxt.lineWidth = previousLineWidth + 2;
                bottomCxt.globalCompositeOperation = 'destination-out';
                this.eraseCircle(bottomCxt);
                this.eraseSkeleton(bottomCxt);
                bottomCxt.globalCompositeOperation = 'source-over';
                bottomCxt.lineWidth = previousLineWidth;
            }
        };
        /**
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.drawCircle = function (bottomCxt) {
            if (this.showCircle)
                this.circle.draw(bottomCxt);
        };
        /**
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.eraseCircle = function (bottomCxt) {
            this.circle.draw(bottomCxt);
        };
        /**
         * @param {CanvasRenderingContext2D} topCxt
         * */
        this.drawDots = function (topCxt) {
            //var previousStyle = topCxt.fillStyle;
            for (var i = 0; i < this.dots.length; i++) {
                var dotPos = rad2cor(this.circle.x, this.circle.y, this.dots[i].distance, this.reverse ? this.angle + this.dots[i].rotOffset : TwoPI - (this.angle + this.dots[i].rotOffset) % TwoPI);
                topCxt.fillStyle = this.dots[i].color;
                topCxt.beginPath();
                topCxt.arc(dotPos[0], dotPos[1], this.dots[i].size, 0, TwoPI);
                topCxt.closePath();
                topCxt.fill();
            }
            //topCxt.fillStyle = previousStyle;
        };
        /**
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.drawSkeleton = function (bottomCxt) {
            if (this.showSkeleton) {
                for (var i = 0; i < this.dots.length; i++) {
                    var dotPos = rad2cor(this.circle.x, this.circle.y, this.dots[i].distance, this.reverse ? this.angle + this.dots[i].rotOffset : TwoPI - (this.angle + this.dots[i].rotOffset) % TwoPI);
                    bottomCxt.moveTo(this.circle.x, this.circle.y);
                    bottomCxt.lineTo(dotPos[0], dotPos[1]);
                }
                bottomCxt.stroke();
            }
        };
        /**
         * @param {CanvasRenderingContext2D} bottomCxt
         * */
        this.eraseSkeleton = function (bottomCxt) {
            if (this.showSkeleton) {
                bottomCxt.beginPath();
                for (var i = 0; i < this.dots.length; i++) {
                    var dotPos = rad2cor(this.circle.x, this.circle.y, this.dots[i].distance, this.reverse ? this.angle + this.dots[i].rotOffset : TwoPI - (this.angle + this.dots[i].rotOffset) % TwoPI);
                    bottomCxt.moveTo(dotPos[0], dotPos[1]);
                    bottomCxt.lineTo(this.circle.x, this.circle.y);
                    bottomCxt.arc(this.circle.x, this.circle.y, 2, 0, TwoPI);
                }
                bottomCxt.closePath();
                bottomCxt.stroke();
                bottomCxt.fill();
            }
        };
        /**
         * @param {number} x
         * @param {number} y
         * */
        this.moveTo = function (x, y) {
            this.circle.moveTo(x, y);
        };
    }

    /**
     * @constructor
     * @param {number} size
     * @param {string} color
     * @param {number} distance
     * @param {number} rotOffset
     * */
    function Dot(size, color, distance, rotOffset) {
        this.size = size;
        this.color = color;
        this.distance = distance;
        this.rotOffset = rotOffset / 180 * Math.PI;
    }

    /**
     * @constructor
     * @param {Number} x
     * @param {Number} y
     * @param {Number} radius
     * */
    function Circle(x, y, radius) {
        this.x = x;
        this.y = y;
        this.radius = radius;

        /**
         * @param {CanvasRenderingContext2D} cxt
         * */
        this.draw = function (cxt) {
            cxt.beginPath();
            cxt.arc(this.x, this.y, radius, 0, TwoPI);
            cxt.closePath();
            cxt.stroke();
        };

        /**
         * @param {CanvasRenderingContext2D} cxt
         * */
        this.erase = function (cxt) {
            cxt.globalCompositeOperation = 'destination-out';
            var previousLineWidth = cxt.lineWidth;
            cxt.lineWidth = previousLineWidth + 2;
            this.draw(cxt);
            cxt.lineWidth = previousLineWidth;
        };

        /**
         * @param {number} x
         * @param {number} y
         * */
        this.moveTo = function (x, y) {
            this.x = x;
            this.y = y;
        }
    }
</script>
<div style="width: 540px; margin: auto auto">
    <span style="font-size:18px;">
        Developed by <a href="https://github.com/hanzhi713" target="_blank">Hanzhi Zhou</a>.
        Click <a href="https://github.com/hanzhi713/Flowers-Curve/wiki" target="_blank">here</a> to see instructions. <a
            href="index-zh.html">訝</a>
    </span>
</div>
</body>
</html>